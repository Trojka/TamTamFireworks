<!DOCTYPE html>
<html>
    <head>
        <title>TamTam Fireworks</title>
        <style type="text/css">
            body{font-family: arial;}
            h4{font-weight:normal;}
        </style>
    </head>
    <body>
        <div id="canvasDiv" style="width:100%;height:100%;border: 1px solid #ddd;"></div>

	<!--Script at the bottom of the page-->
	<script type="text/javascript" src="script/raphael.js" /></script>
    <script>
	
		var initialRadius = 5;
		var explosionExpansionRate1 = 4;
		var explosionExpansionRate2 = 1.25;
		var explosionShrapnelExpansionRate = 15;
		
		var animationStepDuration = 1000;
		
		var xInitPos = 300;
		var yInitPos = 600;
		var shootingHeight = 200;	
		
		var xPosition = xInitPos;
		var yPosition = yInitPos - shootingHeight;
	
        var paper = Raphael("canvasDiv", 650, 1000);   

		paper.customAttributes.guide = function(g) {
			return {guide: g};
		}
		
		paper.customAttributes.along = function(percent) {
			var guide = this.attr("guide");
			var guideLength = guide.getTotalLength();
			var currentPoint = guide.getPointAtLength(percent * guideLength);
			//console.log("animate to point x:"+currentPoint.x+", y:"+currentPoint.y);
			var centerPoint = {
				cx: currentPoint.x,
				cy: currentPoint.y,
				opacity: (1 - percent)
			}
			
			return centerPoint;
		}
		
        var launchStyle = {
            "fill":"#FFFFFF",
            "stroke":"#000000",
            "stroke-width":2
        }
		
		var explosionStyle = {
            "fill":"#FF0000",
            "stroke":"#660000",
            "stroke-width":1
		}
		
		var pathStyle = {
            "opacity":1
		}
		
        var circle = paper.circle(xInitPos, yInitPos, initialRadius).attr(launchStyle);
		
		var positionAnimation = Raphael.animation({
			"cx":xPosition,
			"cy":yPosition
		}, animationStepDuration, 'easeOut');
		
		var exlosionAnimation = Raphael.animation({
			"r" : (initialRadius * explosionExpansionRate1),
			"fill" : "#FF0000",
			"stroke" : "#660000"
		}, animationStepDuration, 'easeOut', function() {
			this.animate(explosionFadeOut);
		});
		
		var explosionFadeOut = Raphael.animation({
			"r" : (initialRadius * explosionExpansionRate1 * explosionExpansionRate2),
			"fill" : "#FFFFFF",
			"stroke" : "#FFFFFF"
		}, animationStepDuration, 'easeOut', function() {
			var count = 28;
			var angleSpacing = (2 * Math.PI) / count;
			
			paper.setStart();
			for(i = 0; i < count; i++) {
				var circle = paper.circle(xPosition, yPosition, 5);
			}
			var explosionSet = paper.setFinish();
			
			explosionSet.attr(explosionStyle);
			
			var explosionIndex = 0;
			explosionSet.forEach(function(e){
				var shrapnelAngle = explosionIndex * angleSpacing;
				var shrapnelRadius = (initialRadius * explosionShrapnelExpansionRate);
				
				var centerPt = xPosition + ", " + yPosition;
				var startX = xPosition + (shrapnelRadius * Math.cos(shrapnelAngle));
				var startY = yPosition + (shrapnelRadius * Math.sin(shrapnelAngle));
				var toX = startX + (shrapnelRadius * Math.cos(shrapnelAngle));
				var toY = startY + (shrapnelRadius * Math.sin(shrapnelAngle));
				var ctrlP2XDelta = (Math.sign(Math.sin(shrapnelAngle)) < 0) ? ((Math.sign(Math.cos(shrapnelAngle))) * 50) : (shrapnelRadius * Math.cos(shrapnelAngle));
				var ctrlP2YDelta = (Math.sign(Math.sin(shrapnelAngle)) < 0) ? 0 : (shrapnelRadius * Math.sin(shrapnelAngle));

				//console.log(explosionIndex + ", " + Math.sign(Math.sin(shrapnelAngle)) + ", " + ctrlP2YDelta);
				
				//https://www.safaribooksonline.com/library/view/raphaeljs/9781449365356/ch04.html
				var startPt = startX + ", " + startY;
				var ctrlP1 = toX + "," + toY + " ";
				var ctrlP2 = (toX + ctrlP2XDelta) + "," + (toY + ctrlP2YDelta) + " ";				
				var endP = (toX + ctrlP2XDelta) + "," + (toY + ctrlP2YDelta + yInitPos)
				
				//paper.circle(startX, startY, 2).attr({"fill":"green"});
				//paper.circle(toX, toY, 2).attr({"fill":"blue"});
				//paper.circle((toX + ctrlP2XDelta), (toY + ctrlP2YDelta), 2).attr({"fill":"yellow"});
				//paper.circle((toX + ctrlP2XDelta), (toY + ctrlP2YDelta + 300), 2).attr({"fill":"brown"});
				
				var pathString = 
					"M " + centerPt + 
					"L " + startPt +
					"M " + startPt + 
					" C " + 
					ctrlP1 +
					ctrlP2 +
					endP;
					
				//console.log(pathString);
				var path = paper.path(pathString).attr(pathStyle);
				var elem = e;
				var duration = animationStepDuration * path.getTotalLength() / shrapnelRadius;
				
				function animateAlongPath() {
					//console.log("will now animate along the path[" + path.attr("path") + "]");
					elem.attr({
						guide: path,
						along: 0
					});
					elem.animate({along: 1}, duration, 'easeOut');
				};
				
				// Animate along a path
				// https://www.safaribooksonline.com/library/view/learning-raphael-js/9781782169161/ch05s05.html
				// http://stackoverflow.com/questions/13295656/raphaeljs-2-1-animate-along-path
				// https://github.com/DmitryBaranovskiy/raphaeljs.com/blob/master/gear.html
				// https://dmitrybaranovskiy.github.io/raphael/reference.html#Paper.customAttributes
				
				//e.animate({
				//	"cx" : startX,
				//	"cy" : startY
				//}, animationStepDuration, 'linear', animateAlongPath);
				
				e.attr({
					guide: path,
					along: 0
				});
				
				e.animate({
					along: 1
				}, duration, 'easeOut');

				explosionIndex++;
			});
		});
		
		//var count = 10;
		//var angleSpacing = (2 * Math.PI) / count;
		//var explosionIndex = 2;
		//var shrapnelAngle = explosionIndex * angleSpacing;
		//var shrapnelRadius = yPosition; //(initialRadius * explosionShrapnelExpansionRate);
		//var toX = xPosition + (shrapnelRadius * Math.cos(shrapnelAngle));
		//var toY = yPosition + (shrapnelRadius * Math.sin(shrapnelAngle));
		
		//paper.circle(xPosition, yPosition, 2).attr({"fill":"red"});
		//paper.circle(toX, toY, 2).attr({"fill":"yellow"});
		//paper.circle(xPosition, 200, 2).attr({"fill":"black"});
		
		var pathString = "M 300, 100 C " + 
			toX + "," + toY + " " +
			(toX + 50) + "," + toY + " " +
			(toX + 50) + "," + 300;
			
		//console.log(pathString);
		
		//paper.path(pathString);
		
		circle.animate(positionAnimation);
		circle.animate(exlosionAnimation.delay(animationStepDuration));
		
		// Following doesn't work, you must put it into the continuation of the previous animation
		//circle.animate(explosionFadeOut.delay(2000));
		
    </script>
</body>
</html>